###################
# BUILD FOR LOCAL DEVELOPMENT
###################
FROM node:18.4.0-alpine AS development

WORKDIR /usr/apps/gateway

RUN apk add --no-cache --virtual .build-deps alpine-sdk python3 libc6-compat

###################
# BUILD FOR PRODUCTION
###################
FROM node:18.4.0-alpine AS build
WORKDIR /usr/apps/gateway

    # Common
ENV DEBUG=false
ENV PRODUCT_NAME=Amonga
ENV NODE_ENV=test
    
    # NETWORK
ENV PUBLIC_IP=192.168.100.27
ENV GATEWAY_PORT=3001
ENV USER_SERVICE_PORT=3002
ENV TOKEN_SERVICE_PORT=3003
ENV POSITION_SERVICE_PORT=3004
ENV FILE_SERVICE_PORT=3005
ENV BRANCH_SERVICE_PORT=3006
ENV PRODUCT_SERVICE_PORT=3007
ENV COMPANY_SERVICE_PORT=3008
ENV MARKETING_SERVICE_PORT=3009
ENV ROLE_SERVICE_PORT=3010
ENV DEPARTMENT_SERVICE_PORT=3011
ENV DEPARTMENT_SERVICE_PORT=3011
ENV DEPARTMENT_SERVICE_PORT=3011
ENV CUSTOMER_SERVICE_PORT=3012

# Postgres DB
ENV DB_TYPE=postgres
ENV DB_HOST=127.0.0.1
ENV DB_PORT=5432
ENV DB_USERNAME=admin
ENV DB_PASSWORD=123123
ENV DB_DATABASE=amongaDb

# Redis
ENV REDIS_PORT=6379
ENV REDIS_USERNAME=admin
ENV REDIS_PASSWORD=123123

# Rabbitmq
ENV RABBITMQ_DEFAULT_USER=admin
ENV RABBITMQ_DEFAULT_PASS=123123
ENV RABBITMQ_URL=amqp://admin:123123@127.0.0.1:5672
ENV RABBITMQ_GATEWAY_QUEUE=gateway_queue
ENV RABBITMQ_USER_QUEUE=user_queue
ENV RABBITMQ_TOKEN_QUEUE=token_queue
ENV RABBITMQ_POSITION_QUEUE=position_queue
ENV RABBITMQ_FILE_QUEUE=file_queue
ENV RABBITMQ_BRANCH_QUEUE=branch_queue
ENV RABBITMQ_PRODUCT_QUEUE=product_queue
ENV RABBITMQ_MARKETING_QUEUE=marketing_queue
ENV RABBITMQ_COMPANY_QUEUE=company_queue
ENV RABBITMQ_ROLE_QUEUE=role_queue
ENV RABBITMQ_MAILER_QUEUE=mailer_queue
ENV RABBITMQ_CUSTOMER_QUEUE=customer_queue
ENV RABBITMQ_DEPARTMENT_QUEUE=department_queue

COPY main.js ./usr/apps/gateway/

USER node

CMD [ "node", "main.js" ]